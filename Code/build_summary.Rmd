---
author: "Camille Ross"
date: "8/17/2020"
output: html_document
params:
  set_title: "v0.2.3"
  fp_out: "./calanus_for_whales/Versions"
  species: "cfin"
  version: "v0.2.3"
  env_covars: c("sst")
  threshold: "40,000"
title: "`r params$set_title`"
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, echo=FALSE, include = FALSE, message=FALSE}
library(png)
library(grid)
library(gridExtra)
```

## Summary

Model ``r params$version`` was created using ``r params$env_covars`` for ``r params$species``.  The models were averaged into climatologies with one climatology per month.  Evaluations were compiled from the climatological averages and plotted.  Finally, the study area was divided up into three regions, the Mid-Atlantic Bight (MAB), George's Bank (GBK), and the Gulf of Maine (GOM).  Actual versus predicted abundance values were plotted for each region.

## Climatologies

### GAM Climatology

The generalized additive models (GAMs) were run using the mgcv package and were used to model ``r params$species`` abundances.  

```{r display_GAM, echo=FALSE}
# Initialize filepath
fp <- file.path(params$fp_out, params$species, params$version, "Climatologies", "Plots")

# Load images
gam1 <- readPNG(file.path(fp, "gam_proj_1.png"))
gam2 <- readPNG(file.path(fp, "gam_proj_2.png"))
gam3 <- readPNG(file.path(fp, "gam_proj_3.png"))
gam4 <- readPNG(file.path(fp, "gam_proj_4.png"))
gam5 <- readPNG(file.path(fp, "gam_proj_5.png"))
gam6 <- readPNG(file.path(fp, "gam_proj_6.png"))
gam7 <- readPNG(file.path(fp, "gam_proj_7.png"))
gam8 <- readPNG(file.path(fp, "gam_proj_8.png"))
gam9 <- readPNG(file.path(fp, "gam_proj_9.png"))
gam10 <- readPNG(file.path(fp, "gam_proj_10.png"))
gam11 <- readPNG(file.path(fp, "gam_proj_11.png"))
gam12 <- readPNG(file.path(fp, "gam_proj_12.png"))

# Arrange grid
grid.arrange(rasterGrob(gam1), rasterGrob(gam2), rasterGrob(gam3),
             rasterGrob(gam4), rasterGrob(gam5), rasterGrob(gam6),
             rasterGrob(gam7), rasterGrob(gam8), rasterGrob(gam9),
             rasterGrob(gam10), rasterGrob(gam11), rasterGrob(gam12),
             ncol=3)


```

**Figure 1.** Monthly climatological GAM projections.  The climatology was created by averaging together the projections from 2000 to 2017.

### BRT Climatology

The boosted regression tree (BRT) models were run using the gbm package and used to model ``r params$species`` abundances. 

```{r display_BRT, echo=FALSE}
# Load images
brt1 <- readPNG(file.path(fp, "brt_proj_1.png"))
brt2 <- readPNG(file.path(fp, "brt_proj_2.png"))
brt3 <- readPNG(file.path(fp, "brt_proj_3.png"))
brt4 <- readPNG(file.path(fp, "brt_proj_4.png"))
brt5 <- readPNG(file.path(fp, "brt_proj_5.png"))
brt6 <- readPNG(file.path(fp, "brt_proj_6.png"))
brt7 <- readPNG(file.path(fp, "brt_proj_7.png"))
brt8 <- readPNG(file.path(fp, "brt_proj_8.png"))
brt9 <- readPNG(file.path(fp, "brt_proj_9.png"))
brt10 <- readPNG(file.path(fp, "brt_proj_10.png"))
brt11 <- readPNG(file.path(fp, "brt_proj_11.png"))
brt12 <- readPNG(file.path(fp, "brt_proj_12.png"))

# Arrange grid
grid.arrange(rasterGrob(brt1), rasterGrob(brt2), rasterGrob(brt3),
             rasterGrob(brt4), rasterGrob(brt5), rasterGrob(brt6),
             rasterGrob(brt7), rasterGrob(brt8), rasterGrob(brt9),
             rasterGrob(brt10), rasterGrob(brt11), rasterGrob(brt12),
             ncol=3)
```

**Figure 2.** Monthly climatological BRT projections.  The climatology was created by averaging together the projections from 2000 to 2017.

### Biomod Ensemble Climatology

The ensemble models were created using the biomod2 package.  The ensembles consist of BRTs, GAMs, and random forests (RFs).  The ensembles were used to model the right whale feeding threshold, with any abundance greater than ``r params$threshold`` ``r params$species`` per $m^3$ counted as a presence and anything below that threshold counted as an absence.

```{r display_ensemble, echo=FALSE}
# Initialize filepath
fp <- file.path(params$fp_out, params$species, params$version, "Biomod_Climatologies", "Plots")

# Load images
ensemble1 <- readPNG(file.path(fp, "ensemble_proj_1.png"))
ensemble2 <- readPNG(file.path(fp, "ensemble_proj_2.png"))
ensemble3 <- readPNG(file.path(fp, "ensemble_proj_3.png"))
ensemble4 <- readPNG(file.path(fp, "ensemble_proj_4.png"))
ensemble5 <- readPNG(file.path(fp, "ensemble_proj_5.png"))
ensemble6 <- readPNG(file.path(fp, "ensemble_proj_6.png"))
ensemble7 <- readPNG(file.path(fp, "ensemble_proj_7.png"))
ensemble8 <- readPNG(file.path(fp, "ensemble_proj_8.png"))
ensemble9 <- readPNG(file.path(fp, "ensemble_proj_9.png"))
ensemble10 <- readPNG(file.path(fp, "ensemble_proj_10.png"))
ensemble11 <- readPNG(file.path(fp, "ensemble_proj_11.png"))
ensemble12 <- readPNG(file.path(fp, "ensemble_proj_12.png"))

# Arrange grid
grid.arrange(rasterGrob(ensemble1), rasterGrob(ensemble2), rasterGrob(ensemble3),
             rasterGrob(ensemble4), rasterGrob(ensemble5), rasterGrob(ensemble6),
             rasterGrob(ensemble7), rasterGrob(ensemble8), rasterGrob(ensemble9),
             rasterGrob(ensemble10), rasterGrob(ensemble11), rasterGrob(ensemble12),
             ncol=3)


```

**Figure 3.** Monthly climatological ensemble projections of GAMs, BRTs, and random forests (RFs).  The climatology was created by averaging together the projections from 2000 to 2017.

### Biomod GAM Climatology

The GAM models created with biomod2 were used to model the right whale feeding threshold, with any abundance greater than 1,000 ``r params$species`` per $m^3$ counted as a presence and anything below that threshold counted as an absence.  

```{r display_biomod_gam, echo=FALSE}
# Initialize filepath
fp <- file.path(params$fp_out, params$species, params$version, "Biomod_Climatologies", "Plots")

# Load images
gam1 <- readPNG(file.path(fp, "gam_proj_1.png"))
gam2 <- readPNG(file.path(fp, "gam_proj_2.png"))
gam3 <- readPNG(file.path(fp, "gam_proj_3.png"))
gam4 <- readPNG(file.path(fp, "gam_proj_4.png"))
gam5 <- readPNG(file.path(fp, "gam_proj_5.png"))
gam6 <- readPNG(file.path(fp, "gam_proj_6.png"))
gam7 <- readPNG(file.path(fp, "gam_proj_7.png"))
gam8 <- readPNG(file.path(fp, "gam_proj_8.png"))
gam9 <- readPNG(file.path(fp, "gam_proj_9.png"))
gam10 <- readPNG(file.path(fp, "gam_proj_10.png"))
gam11 <- readPNG(file.path(fp, "gam_proj_11.png"))
gam12 <- readPNG(file.path(fp, "gam_proj_12.png"))

# Arrange grid
grid.arrange(rasterGrob(gam1), rasterGrob(gam2), rasterGrob(gam3),
             rasterGrob(gam4), rasterGrob(gam5), rasterGrob(gam6),
             rasterGrob(gam7), rasterGrob(gam8), rasterGrob(gam9),
             rasterGrob(gam10), rasterGrob(gam11), rasterGrob(gam12),
             ncol=3)


```

**Figure 4.** Monthly climatological GAM projections produced using Biomod2.  The climatology was created by averaging together the projections from 2000 to 2017.

## Evaluations

Evaluation metrics differed based on the metrics available in each modeling package and compatible with each model object.  For the mgcv GAMs, Aikaike's Information Criterion (AIC), the root mean squared error (RMSE), and the R squared (RSQ) value when comparing the actual and predicted abundances were computed.  For the BRTs produced using the gbm package, RMSE and RSQ were computed.  For the biomod2 ensembles and GAMs, the area under the receiver operator characteristic curve (AUC) and the true skill statistic (TSS) were computed.  

### GAM evaluations

```{r gam_evals, echo=FALSE}
# Initialize filepath
fp <- file.path(params$fp_out, params$species, params$version, "Climatologies", "Evals")

# Load evals
aic <- readPNG(file.path(fp, "gam_aic.png"))
rmse <- readPNG(file.path(fp, "gam_rmse.png"))
rsq <- readPNG(file.path(fp, "gam_rsq.png"))

# Arrange grid
grid.arrange(rasterGrob(aic), rasterGrob(rmse), rasterGrob(rsq),
             ncol=3)
```

**Figure 5.** Model evaluations on a monthly time scale using a.) AIC, b.) RMSE, and c.) R2.


### BRT evaluations

```{r brt_evals, echo=FALSE}
# Load evals
rmse <- readPNG(file.path(fp, "brt_rmse.png"))
rsq <- readPNG(file.path(fp, "brt_rsq.png"))

# Arrange grid
grid.arrange(rasterGrob(rmse), rasterGrob(rsq),
             ncol=2)
```

**Figure 6.** Model evaluations on a monthly time scale using a.) RMSE and b.) R2.

### Biomod ensemble evaluations

```{r ensemble_evals, echo=FALSE}
# Initialize filepath
fp <- file.path(params$fp_out, params$species, params$version, "Biomod_Climatologies", "Evals")

# Load evals
auc <- readPNG(file.path(fp, "ensemble_auc.png"))
tss <- readPNG(file.path(fp, "ensemble_tss.png"))

# Arrange grid
grid.arrange(rasterGrob(auc), rasterGrob(tss),
             ncol=2)
```

**Figure 7.** Biomod ensemble evaluations on a monthly time scale using a.) AUC and b.) TSS

### Biomod GAM evaluations

```{r gam_biomod_evals, echo=FALSE}
# Load evals
auc <- readPNG(file.path(fp, "gam_auc.png"))
tss <- readPNG(file.path(fp, "gam_tss.png"))

# Arrange grid
grid.arrange(rasterGrob(auc), rasterGrob(tss),
             ncol=2)
```

**Figure 8.** Biomod GAM evaluations on a monthly time scale using a.) AUC and b.) TSS

## Regions 

The study area was divided into three regions, the MAB, GBK, and GOM.  For each region, a climatological average (one point per month), monthly average time series, and annual average time series were computed and the actual versus predicted abundance values were plotted.  So far, this has only been done for the mgcv GAMs and gbm BRTs. 

### GAM regions

#### Climatological average

```{r gam_clim, echo=FALSE}
# Initialize filepath
fp <- file.path(params$fp_out, params$species, params$version, "Climatologies", "Plots")

# Load filenames
files <- list.files(fp)

# Load region plots
mab <- readPNG(file.path(fp, "MAB_gam_abund_pred_climatological.png"))

if ("GBK_gam_abund_pred_climatological.png" %in% files) {
  gbk <- readPNG(file.path(fp, "GBK_gam_abund_pred_climatological.png"))
}

gom <- readPNG(file.path(fp, "GOM_gam_abund_pred_climatological.png"))


# Arrange grid
if ("GBK_gam_abund_pred_climatological.png" %in% files) {
  grid.arrange(rasterGrob(mab), rasterGrob(gbk), rasterGrob(gom),
              ncol=3)
} else {
  grid.arrange(rasterGrob(mab), rasterGrob(gom),
              ncol=2)
}

```

**Figure 9.** Climatological abundance values averaged over three regions, a.) the Mid Atlantic Bight, b.) George's Bank, and c.) the Gulf of Maine.  The predicted values come from the projections.

#### Monthly average time series

```{r gam_monthly, echo=FALSE}
# Initialize filepath
fp <- file.path(params$fp_out, params$species, params$version, "GAMs", "Plots")

# Load filenames
files <- list.files(fp)

# Load region plots
mab <- readPNG(file.path(fp, "MAB_gam_abund_pred_monthly.png"))

if ("GBK_gam_abund_pred_monthly.png" %in% files) {
  gbk <- readPNG(file.path(fp, "GBK_gam_abund_pred_monthly.png"))
}

gom <- readPNG(file.path(fp, "GOM_gam_abund_pred_monthly.png"))


# Arrange grid
if ("GBK_gam_abund_pred_monthly.png" %in% files) {
  grid.arrange(rasterGrob(mab), rasterGrob(gbk), rasterGrob(gom),
              ncol=3)
} else {
  grid.arrange(rasterGrob(mab), rasterGrob(gom),
              ncol=2)
}

```

**Figure 10.** Abundance values averaged monthly over three regions, a.) the Mid Atlantic Bight, b.) George's Bank, and c.) the Gulf of Maine.  The predicted values come from the projections.

#### Monthly average time series

```{r gam_annual, echo=FALSE}
# Load filenames
files <- list.files(fp)

# Load region plots
mab <- readPNG(file.path(fp, "MAB_gam_abund_pred_annual.png"))

if ("GBK_gam_abund_pred_annual.png" %in% files) {
  gbk <- readPNG(file.path(fp, "GBK_gam_abund_pred_annual.png"))
}

gom <- readPNG(file.path(fp, "GOM_gam_abund_pred_annual.png"))


# Arrange grid
if ("GBK_gam_abund_pred_annual.png" %in% files) {
  grid.arrange(rasterGrob(mab), rasterGrob(gbk), rasterGrob(gom),
              ncol=3)
} else {
  grid.arrange(rasterGrob(mab), rasterGrob(gom),
              ncol=2)
}

```

**Figure 11.** Abundance values averaged annually over three regions, a.) the Mid Atlantic Bight, b.) George's Bank, and c.) the Gulf of Maine.  The predicted values come from the projections.

### BRT regions

#### Climatological average

```{r brt_clim, echo=FALSE}
# Initialize filepath
fp <- file.path(params$fp_out, params$species, params$version, "Climatologies", "Plots")

# Load filenames
files <- list.files(fp)

# Load region plots
mab <- readPNG(file.path(fp, "MAB_brt_abund_pred_climatological.png"))

if ("GBK_brt_abund_pred_climatological.png" %in% files) {
  gbk <- readPNG(file.path(fp, "GBK_brt_abund_pred_climatological.png"))
}

gom <- readPNG(file.path(fp, "GOM_brt_abund_pred_climatological.png"))


# Arrange grid
if ("GBK_brt_abund_pred_climatological.png" %in% files) {
  grid.arrange(rasterGrob(mab), rasterGrob(gbk), rasterGrob(gom),
              ncol=3)
} else {
  grid.arrange(rasterGrob(mab), rasterGrob(gom),
              ncol=2)
}

```

**Figure 12.** Climatological abundance values averaged over three regions, a.) the Mid Atlantic Bight, b.) George's Bank, and c.) the Gulf of Maine.  The predicted values come from the projections.

#### Monthly average time series

```{r brt_monthly, echo=FALSE}
# Initialize filepath
fp <- file.path(params$fp_out, params$species, params$version, "BRTs", "Plots")

# Load filenames
files <- list.files(fp)

# Load region plots
mab <- readPNG(file.path(fp, "MAB_brt_abund_pred_monthly.png"))

if ("GBK_brt_abund_pred_monthly.png" %in% files) {
  gbk <- readPNG(file.path(fp, "GBK_brt_abund_pred_monthly.png"))
}

gom <- readPNG(file.path(fp, "GOM_brt_abund_pred_monthly.png"))


# Arrange grid
if ("GBK_brt_abund_pred_monthly.png" %in% files) {
  grid.arrange(rasterGrob(mab), rasterGrob(gbk), rasterGrob(gom),
              ncol=3)
} else {
  grid.arrange(rasterGrob(mab), rasterGrob(gom),
              ncol=2)
}

```

**Figure 13.** Abundance values averaged monthly over three regions, a.) the Mid Atlantic Bight, b.) George's Bank, and c.) the Gulf of Maine.  The predicted values come from the projections.

#### Monthly average time series

```{r brt_annual, echo=FALSE}
# Load filenames
files <- list.files(fp)

# Load region plots
mab <- readPNG(file.path(fp, "MAB_brt_abund_pred_annual.png"))

if ("GBK_brt_abund_pred_annual.png" %in% files) {
  gbk <- readPNG(file.path(fp, "GBK_brt_abund_pred_annual.png"))
}

gom <- readPNG(file.path(fp, "GOM_brt_abund_pred_annual.png"))


# Arrange grid
if ("GBK_brt_abund_pred_annual.png" %in% files) {
  grid.arrange(rasterGrob(mab), rasterGrob(gbk), rasterGrob(gom),
              ncol=3)
} else {
  grid.arrange(rasterGrob(mab), rasterGrob(gom),
              ncol=2)
}

```

**Figure 14.** Abundance values averaged annually over three regions, a.) the Mid Atlantic Bight, b.) George's Bank, and c.) the Gulf of Maine.  The predicted values come from the projections.